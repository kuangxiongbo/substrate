# Implementation Plan: 用户认证系统

**Branch**: `001-` | **Date**: 2025-10-01 | **Spec**: [spec.md](./spec.md)

## Summary

**Primary Requirement**: Build a secure, JWT-based user authentication system supporting email/password registration, login, session management, and password reset functionality with GDPR compliance.

**Technical Approach**: RESTful API backend using FastAPI with JWT tokens, bcrypt/Argon2 password hashing, configurable password policies, email verification, and comprehensive security logging. Dual-token strategy (access + refresh tokens) with token rotation.

## Technical Context

**Language**: Python 3.11+  
**Framework**: FastAPI + SQLAlchemy + Alembic  
**Database**: PostgreSQL 14+  
**Cache/Rate Limit**: Redis 6+  
**Testing**: pytest + pytest-asyncio + httpx  
**Password Hashing**: Argon2id (with bcrypt fallback)  
**JWT Library**: python-jose  
**Email**: aiosmtplib + jinja2  
**Project Type**: Web API (backend authentication service)

**Performance Goals**: <200ms login, <10ms token validation, 1000 concurrent users

**Constraints**: HTTPS only, JWT stateless access tokens, 90-day log retention, GDPR compliant

## Constitution Check ✅ PASSED

- ✅ TDD: Contract tests before implementation
- ✅ Code Quality: FastAPI + Pydantic type safety, linting planned  
- ✅ Documentation: Complete specs, OpenAPI auto-generated
- ✅ Performance: Async operations, database indexes
- ✅ Security: Argon2, JWT, HTTPS, rate limiting, GDPR

## Project Structure

### Documentation
```
specs/001-/
├── spec.md           # Feature specification (278 lines, 41 requirements)
├── plan.md           # This file
├── research.md       # Technology decisions
├── data-model.md     # Database schema
├── quickstart.md     # Developer guide
├── contracts/        # OpenAPI specs
└── tasks.md          # Task list (generated by /tasks)
```

### Source Code
```
backend/
├── src/
│   ├── main.py
│   ├── models/       # User, JWTToken, VerificationToken, SecurityLog
│   ├── schemas/      # Pydantic request/response schemas
│   ├── services/     # Business logic
│   ├── api/v1/       # Route handlers
│   ├── middleware/   # Rate limiting, security headers
│   └── utils/        # Helpers
├── tests/
│   ├── contract/     # API schema validation
│   ├── integration/  # Full flow tests
│   ├── unit/         # Service tests
│   └── security/     # Security-specific tests
├── requirements.txt
└── docker-compose.yml
```

## Phase 0: Research ✅ COMPLETE

**Key Decisions**:
1. **Password Hashing**: Argon2id (winner of Password Hashing Competition, GPU-resistant)
2. **JWT Strategy**: Hybrid - stateless access tokens (1h) + tracked refresh tokens (7d) with rotation
3. **Rate Limiting**: Redis-based sliding window (slowapi library)
4. **Email**: aiosmtplib async SMTP with Jinja2 templates
5. **Password Policies**: Config-based Basic (8 chars) / High (12 chars + special) levels
6. **GDPR**: Dedicated endpoints for data export/deletion + consent tracking

See `research.md` for detailed rationale.

## Phase 1: Design ✅ COMPLETE

### Data Model (4 entities)
- **User**: email, password_hash, email_verified, account_status, failed_login_attempts, GDPR fields
- **JWTToken**: jti, user_id, token_type, expires_at, revoked (for refresh tokens and blacklist)
- **VerificationToken**: token, user_id, token_type (email/reset), expires_at, used
- **SecurityLog**: event_type, user_id, timestamp, ip_address, result, failure_reason

**Indexes**: email (unique), jti (unique), timestamps, user_id composites

### API Contracts (12 endpoints)
- POST /auth/register, /auth/login, /auth/refresh, /auth/logout
- GET /auth/verify-email/{token}, /auth/password-requirements
- POST /auth/forgot-password, /auth/reset-password
- GET /users/me, /users/me/data
- POST /users/me/change-password
- DELETE /users/me

**Contract Tests**: Written for all endpoints (currently failing - red phase)

See `data-model.md` and `contracts/` for details.

## Phase 2: Task Planning Approach

**What /tasks will generate** (60-70 tasks):
- Models: 8 tasks (4 models × [create + tests])
- Services: 15 tasks (Auth, Token, Password, Email, Security services)
- Contract Tests: 12 tasks (one per endpoint)
- API Implementation: 12 tasks (make tests green)
- Integration Tests: 15 tasks (user story scenarios)
- Infrastructure: 8-10 tasks (migrations, Redis, email templates, Docker)

**Task Ordering**:
1. Foundation [P]: Models, config, utils
2. Services: Password → Token → Email → Auth → Security
3. Contract Tests (TDD): All tests written, all failing
4. Implementation: Make tests pass
5. Integration Tests: Full flows
6. Infrastructure: Rate limiting, logging, cleanup jobs

Tasks marked [P] can run in parallel.

**Next Command**: Run `/tasks` to generate `tasks.md`

## Progress Tracking

**Phase Status**:
- [x] Phase 0: Research ✅
- [x] Phase 1: Design ✅
- [x] Phase 2: Approach defined ✅
- [ ] Phase 3: Tasks (/tasks command)
- [ ] Phase 4: Implementation
- [ ] Phase 5: Validation

**Gates**:
- [x] Initial Constitution Check: PASS ✅
- [x] Post-Design Constitution Check: PASS ✅
- [x] All NEEDS CLARIFICATION resolved ✅

---

*Based on Constitution v1.0.0*  
*Ready for: `/tasks` command*
